\DeclareExerciseProperty{container}      % the container that is the direct parent of an exercise
\DeclareExerciseProperty{container-type} % its type

\ExplSyntaxOn

\tl_new:N   \g_xsim_nested_container_tl      % the containe we're nestingcurrently in
\tl_new:N   \g_xsim_nested_container_type_tl % its type

% this pre-hook sets the container of the currect exercise using the global container variable
% and the sets this variable to point to the current exercise (until the post-hook is executed)
% #1: type
\cs_new:Nn \xsim_nested_pre_hook:n {
    \tl_if_empty:NF \g_xsim_nested_container_tl {
        \xsim_set_property:xxnx{#1}{\g_xsim_exercise_id_tl}{container}{\g_xsim_nested_container_tl}
        \xsim_set_property:xxnx{#1}{\g_xsim_exercise_id_tl}{container-type}{\g_xsim_nested_container_type_tl}
    }

    \tl_gset_eq:NN \g_xsim_nested_container_tl \g_xsim_exercise_id_tl 
    \tl_gset:Nn \g_xsim_nested_container_type_tl {#1}
}
\cs_generate_variant:Nn \xsim_nested_pre_hook:n {x}
\NewDocumentCommand \XSIMNestedPreHook {m} {\xsim_nested_pre_hook:n{#1}}

% this post-hook reverts the changes made by the pre-hook, popping one level of nesting off the stack
% additionally, it correctly reverts XSIM internals so that footer-templates have the correct \ExerciseID
% #1: type
\cs_new:Nn \xsim_nested_post_hook:n {
    \xsim_verbose:x {
        Resetting~ #1 ~ context~ from~ \g_xsim_nested_container_type_tl ~ \g_xsim_nested_container_tl ~ (globally~ set~ \g_xsim_exercise_id_tl ~ =~ \ExerciseType ~ \ExerciseID )...
    }

    \xsim_if_property_set:xxnTF{#1}{\g_xsim_nested_container_tl}{container}{
        % reset the global container variable to be equal to the container of the parent
        \tl_gset:Nx \g_xsim_nested_container_type_tl {\xsim_get_property:non{#1}{\g_xsim_nested_container_tl}{container-type}}
        \tl_gset:Nx \g_xsim_nested_container_tl {\xsim_get_property:non{#1}{\g_xsim_nested_container_tl}{container}}
    }{
        % we have no parent container, so we reached the root level again
        \tl_gclear:N \g_xsim_nested_container_tl
        \tl_gclear:N \g_xsim_nested_container_type_tl
    }

    % update XSIM internals
    \tl_gset_eq:NN \g_xsim_exercise_id_tl \g_xsim_nested_container_tl
    \tl_gset_eq:NN \ExerciseID \g_xsim_exercise_id_tl
    \tl_gset_eq:NN \ExerciseType \g_xsim_nested_container_type_tl

    \xsim_verbose:x {
        ...to~ \g_xsim_nested_container_type_tl ~ \g_xsim_nested_container_tl ~ (globally~ set~ \g_xsim_exercise_id_tl ~ =~ \ExerciseType ~ \ExerciseID ).
    }
}
\cs_generate_variant:Nn \xsim_nested_post_hook:n {x}
\NewDocumentCommand \XSIMNestedPostHook {m} {\xsim_nested_post_hook:n{#1}}

% use this to call xsim_setup and register the respectice hooks automatically
% #1: type (e.g. exercise, subexercise,... needs to be called for each type individually)
\cs_new:Nn \xsim_nested_setup:n {
    \xsim_setup:n{
        #1/pre-hook={
            \xsim_nested_pre_hook:n{#1}
        },
        #1/post-hook={
            \xsim_nested_post_hook:n{#1}
        }
    }
}
\cs_generate_variant:Nn \xsim_nested_setup:n {x}
\NewDocumentCommand \XSIMNestedSetup {m} {\xsim_nested_setup:n{#1}}

\ExplSyntaxOff